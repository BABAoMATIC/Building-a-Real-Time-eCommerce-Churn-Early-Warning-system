# Kafka User Event Producer

This directory contains a Kafka producer that sends user events to the `user-events` topic every 3 seconds.

## Files

- **`user_event_producer.py`** - Main producer script
- **`test_producer.py`** - Test script to send sample events
- **`user_event_consumer.py`** - Consumer script to verify events
- **`PRODUCER_README.md`** - This documentation

## Event Format

Each event sent to the `user-events` topic contains:

```json
{
    "user_id": 1234,
    "event_type": "add_to_cart",
    "timestamp": "2024-01-15T10:30:00.123456",
    "metadata": {
        "product_id": "PROD-5678",
        "session_length": 45.67
    }
}
```

### Event Types

The producer randomly selects from these event types:
- `add_to_cart`
- `product_view`
- `bounce`
- `checkout`

### Metadata Fields

- **`product_id`**: Random product ID (format: PROD-XXXX)
- **`session_length`**: Random session length in minutes (1-120 minutes)

## Usage

### Prerequisites

1. **Kafka Server**: Make sure Kafka is running on `localhost:9092`
2. **Topic**: Create the `user-events` topic (or it will be auto-created)
3. **Dependencies**: Install required packages

```bash
pip install kafka-python
```

### Running the Producer

```bash
python user_event_producer.py
```

This will:
- Connect to Kafka on `localhost:9092`
- Send events to the `user-events` topic
- Send one event every 3 seconds
- Log each event to the console
- Continue until stopped with Ctrl+C

### Testing the Producer

Send a few test events:

```bash
python test_producer.py
```

### Consuming Events

To verify events are being sent, run the consumer:

```bash
python user_event_consumer.py
```

## Configuration

You can modify the configuration in the `main()` function:

```python
KAFKA_SERVERS = 'localhost:9092'  # Kafka broker address
TOPIC = 'user-events'             # Topic name
INTERVAL_SECONDS = 3              # Seconds between events
```

## Console Output

The producer logs each event to the console:

```
2024-01-15 10:30:00,123 - INFO - Event sent - User: 1234, Type: add_to_cart, Product: PROD-5678, Session: 45.67min, Partition: 0
2024-01-15 10:30:03,456 - INFO - Total events sent: 1
```

## Error Handling

The producer includes robust error handling:
- **Connection errors**: Retries with backoff
- **Send failures**: Logs errors and continues
- **Kafka errors**: Graceful error handling
- **Keyboard interrupt**: Clean shutdown

## Integration with Flask API

The events generated by this producer can be consumed by your Flask API for churn prediction:

1. **Start the producer**: `python user_event_producer.py`
2. **Start the Flask API**: `python app.py` (or `app_with_ml.py`)
3. **Events flow**: Producer → Kafka → Consumer → Flask API → Churn Prediction

## Troubleshooting

### Common Issues

1. **Connection refused**: Make sure Kafka is running on `localhost:9092`
2. **Topic not found**: The topic will be auto-created, or create it manually
3. **Import errors**: Install kafka-python: `pip install kafka-python`

### Kafka Setup

If you need to set up Kafka locally:

```bash
# Download and start Kafka
wget https://downloads.apache.org/kafka/2.8.0/kafka_2.13-2.8.0.tgz
tar -xzf kafka_2.13-2.8.0.tgz
cd kafka_2.13-2.8.0

# Start Zookeeper
bin/zookeeper-server-start.sh config/zookeeper.properties

# Start Kafka (in another terminal)
bin/kafka-server-start.sh config/server.properties

# Create topic (optional - will be auto-created)
bin/kafka-topics.sh --create --topic user-events --bootstrap-server localhost:9092 --partitions 1 --replication-factor 1
```

### Docker Alternative

Use Docker Compose for easier setup:

```yaml
version: '3.8'
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
```

## Monitoring

To monitor the Kafka topic:

```bash
# List topics
bin/kafka-topics.sh --list --bootstrap-server localhost:9092

# Describe topic
bin/kafka-topics.sh --describe --topic user-events --bootstrap-server localhost:9092

# Consume messages
bin/kafka-console-consumer.sh --topic user-events --from-beginning --bootstrap-server localhost:9092
```
